<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Backoffice - Blind Chat</title>
    <link rel="stylesheet" href="/front/styles.css" />
    <style>
      body {
        background: linear-gradient(135deg, #2d1b4e 0%, #4a2c6d 50%, #6b3fa0 100%);
        color: #e0e0e0;
        min-height: 100vh;
      }
      .backoffice-container {
        max-width: 800px;
        margin: 50px auto;
        padding: 40px;
        background: rgba(45, 27, 78, 0.9);
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(107, 63, 160, 0.4);
        text-align: center;
        border: 1px solid rgba(139, 92, 186, 0.5);
        backdrop-filter: blur(10px);
      }
      h1 {
        color: #b88ce8;
        font-size: 32px;
        margin-bottom: 20px;
        text-shadow: 0 2px 10px rgba(184, 140, 232, 0.5);
        font-weight: 600;
      }
      .login-container {
        max-width: 420px;
        margin: 50px auto;
        padding: 40px;
        background: rgba(45, 27, 78, 0.95);
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(107, 63, 160, 0.4);
        border: 1px solid rgba(139, 92, 186, 0.5);
        backdrop-filter: blur(10px);
      }
      .login-container .header h1 {
        color: #b88ce8;
        text-shadow: 0 2px 10px rgba(184, 140, 232, 0.5);
      }
      .login-container .header p {
        color: #d4c5e8;
      }
      .form-group label {
        color: #d4c5e8;
      }
      .form-group input {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(139, 92, 186, 0.3);
        color: #e0e0e0;
      }
      .form-group input::placeholder {
        color: rgba(224, 224, 224, 0.5);
      }
      .form-group input:focus {
        border-color: #b88ce8;
        box-shadow: 0 0 0 3px rgba(184, 140, 232, 0.2);
        background: rgba(255, 255, 255, 0.15);
      }
      .btn-submit {
        background: linear-gradient(135deg, #8b5cba 0%, #b88ce8 100%);
        box-shadow: 0 4px 15px rgba(184, 140, 232, 0.4);
      }
      .btn-submit:hover {
        box-shadow: 0 8px 25px rgba(184, 140, 232, 0.6);
        transform: translateY(-2px);
      }
      .btn-submit:disabled {
        background: rgba(139, 92, 186, 0.4);
        opacity: 0.6;
      }
      .message.success {
        background: rgba(139, 195, 74, 0.2);
        color: #b8e986;
        border: 1px solid rgba(139, 195, 74, 0.4);
      }
      .message.error {
        background: rgba(244, 67, 54, 0.2);
        color: #ff9999;
        border: 1px solid rgba(244, 67, 54, 0.4);
      }
      .admin-badge {
        display: inline-block;
        background: linear-gradient(135deg, #8b5cba 0%, #b88ce8 100%);
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 16px;
        box-shadow: 0 2px 10px rgba(184, 140, 232, 0.4);
      }
      .back-link {
        text-align: center;
        margin-top: 20px;
      }
      .back-link a {
        color: #b88ce8;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s;
      }
      .back-link a:hover {
        color: #d4c5e8;
        text-shadow: 0 0 10px rgba(184, 140, 232, 0.5);
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="loginView" class="login-container">
      <div class="header">
        <div class="admin-badge">üîê √Årea de Administraci√≥n</div>
        <h1>Backoffice</h1>
        <p>Acceso exclusivo para administradores</p>
      </div>

      <div class="form-container active">
        <form id="adminLoginForm">
          <div class="form-group">
            <label for="adminUser">Usuario Administrador</label>
            <input 
              type="text" 
              id="adminUser" 
              name="user" 
              required 
              autocomplete="username"
              placeholder="Ingresa tu usuario"
            />
          </div>
          <div class="form-group">
            <label for="adminPassword">Contrase√±a</label>
            <input
              type="password"
              id="adminPassword"
              name="password"
              required
              autocomplete="current-password"
              placeholder="Ingresa tu contrase√±a"
            />
          </div>
          <button type="submit" class="btn-submit" id="adminLoginSubmit">
            Acceder al Backoffice
          </button>
        </form>
      </div>

      <div id="message" class="message"></div>

      <div class="back-link">
        <a href="/front/index.html">‚Üê Volver al login de usuarios</a>
      </div>
    </div>

    <div id="backofficeView" class="backoffice-container hidden">
      <h1 id="adminName">Cargando...</h1>
    </div>

    <script src="/front/config.js"></script>
    <script>
      const loginView = document.getElementById("loginView");
      const backofficeView = document.getElementById("backofficeView");
      const adminLoginForm = document.getElementById("adminLoginForm");
      const messageDiv = document.getElementById("message");

      const checkSession = async () => {
        let data = null;

        try {
          const res = await fetch(`${API_BASE_URL}/check_session.php`, {
            credentials: "include",
          });
          data = await res.json();
          if (data.success && data.user) {
            return data;
          }
        } catch (error) {
        }

        const sessionId = localStorage.getItem("session_id");
        if (sessionId && (!data || !data.success)) {
          try {
            const res = await fetch(`${API_BASE_URL}/check_session_by_id.php`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ session_id: sessionId }),
            });
            data = await res.json();
          } catch (error) {
          }
        }

        return data;
      };

      const showMessage = (text, type) => {
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
        setTimeout(() => {
          messageDiv.className = "message";
          messageDiv.textContent = "";
        }, 5000);
      };

      adminLoginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById("adminLoginSubmit");
        submitBtn.disabled = true;
        submitBtn.textContent = "Verificando credenciales...";

        const user = document.getElementById("adminUser").value;
        const password = document.getElementById("adminPassword").value;

        try {
          const response = await fetch(`${API_BASE_URL}/login.php`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify({ user, password }),
          });

          const result = await response.json();

          if (result.success) {
            if (result.is_admin !== true) {
              showMessage("Acceso denegado. Esta √°rea es solo para administradores.", "error");
              submitBtn.disabled = false;
              submitBtn.textContent = "Acceder al Backoffice";
              return;
            }

            let sessionId = result.session_id;
            
            if (!sessionId) {
              sessionId = response.headers.get('X-Session-ID');
            }
            
            if (sessionId) {
              localStorage.setItem('session_id', sessionId);
            }
            
            showMessage("Acceso concedido. Cargando backoffice...", "success");
            setTimeout(() => {
              loginView.classList.add("hidden");
              backofficeView.classList.remove("hidden");
              document.getElementById("adminName").textContent = `Backoffice - ${user}`;
            }, 800);
          } else {
            showMessage(result.message || "Credenciales incorrectas", "error");
          }
        } catch (error) {
          showMessage("Error de conexi√≥n con el servidor", "error");
          console.error("Error:", error);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Acceder al Backoffice";
        }
      });

      setTimeout(async () => {
        const data = await checkSession();

        if (data && data.success && data.user && data.is_admin) {
          loginView.classList.add("hidden");
          backofficeView.classList.remove("hidden");
          document.getElementById("adminName").textContent = `Backoffice - ${data.user}`;
        } else {
          if (data && data.success && !data.is_admin) {
            localStorage.removeItem("session_id");
          }
        }
      }, 100);
    </script>
  </body>
</html>
